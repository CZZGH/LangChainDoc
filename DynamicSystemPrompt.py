from typing import TypedDict
from langchain.tools import tool
from langchain.agents import create_agent
from langchain.agents.middleware import dynamic_prompt, ModelRequest

from my_llm import create_llm

llm = create_llm("deepseek-v3.2")


class Context(TypedDict):
    user_role: str

@dynamic_prompt
def user_role_prompt(request: ModelRequest) -> str:
    """Generate system prompt based on user role."""
    user_role = request.runtime.context.get("user_role", "user")
    base_prompt = "You are a helpful assistant."

    if user_role == "expert":
        return f"{base_prompt} Provide detailed technical responses."
    elif user_role == "beginner":
        return f"{base_prompt} Explain concepts simply and avoid jargon."

    return base_prompt

@tool
def web_search(query: str) -> str:
    """Perform a web search for the given query."""
    return f"Search results for: {query}"

agent = create_agent(
    model=llm,
    tools=[web_search],
    middleware=[user_role_prompt],
    context_schema=Context
)

# The system prompt will be set dynamically based on context
result = agent.invoke(
    {"messages": [{"role": "user", "content": "Explain machine learning"}]},
    context={"user_role": "expert"}
)
print(result)

'''
output:
{'messages': [HumanMessage(content='Explain machine learning', additional_kwargs={}, response_metadata={}, id='a32110cd-bea3-414c-ab93-b9c34ead8bbe'), AIMessage(content="I'll help you understand machine learning. Let me search for comprehensive, up-to-date information about machine learning concepts, applications, and current trends.", additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 79, 'prompt_tokens': 313, 'total_tokens': 392, 'completion_tokens_details': None, 'prompt_tokens_details': None}, 'model_provider': 'openai', 'model_name': 'deepseek-v3.2', 'system_fingerprint': None, 'id': 'chatcmpl-9211e321-6dc3-9787-a2dc-73e5d74a86e6', 'finish_reason': 'tool_calls', 'logprobs': None}, id='lc_run--019b87c9-208e-7881-8442-f51921f5a2a7-0', tool_calls=[{'name': 'web_search', 'args': {'query': 'machine learning basics concepts algorithms applications 2024'}, 'id': 'call_753eaeb712de4eba94cd1afd', 'type': 'tool_call'}], invalid_tool_calls=[], usage_metadata={'input_tokens': 313, 'output_tokens': 79, 'total_tokens': 392, 'input_token_details': {}, 'output_token_details': {}}), ToolMessage(content='Search results for: machine learning basics concepts algorithms applications 2024', name='web_search', id='a661e3ba-78a9-4b8d-897e-47232f416eb7', tool_call_id='call_753eaeb712de4eba94cd1afd'), AIMessage(content='', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 51, 'prompt_tokens': 422, 'total_tokens': 473, 'completion_tokens_details': None, 'prompt_tokens_details': None}, 'model_provider': 'openai', 'model_name': 'deepseek-v3.2', 'system_fingerprint': None, 'id': 'chatcmpl-eabcb397-ee98-9267-8f53-a6ccec64bafa', 'finish_reason': 'tool_calls', 'logprobs': None}, id='lc_run--019b87c9-b4a3-7673-a241-3a1a81d8401a-0', tool_calls=[{'name': 'web_search', 'args': {'query': 'what is machine learning types supervised unsupervised deep learning'}, 'id': 'call_6e7df3a9c7db4928a8156db8', 'type': 'tool_call'}], invalid_tool_calls=[], usage_metadata={'input_tokens': 422, 'output_tokens': 51, 'total_tokens': 473, 'input_token_details': {}, 'output_token_details': {}}), ToolMessage(content='Search results for: what is machine learning types supervised unsupervised deep learning', name='web_search', id='cad0e704-3f60-4225-82a5-5a439c83e94b', tool_call_id='call_6e7df3a9c7db4928a8156db8'), AIMessage(content='', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 50, 'prompt_tokens': 503, 'total_tokens': 553, 'completion_tokens_details': None, 'prompt_tokens_details': None}, 'model_provider': 'openai', 'model_name': 'deepseek-v3.2', 'system_fingerprint': None, 'id': 'chatcmpl-3271835c-5f32-9e0e-8557-c1f49d804970', 'finish_reason': 'tool_calls', 'logprobs': None}, id='lc_run--019b87c9-bc4a-7d23-a92a-11aca0094eb3-0', tool_calls=[{'name': 'web_search', 'args': {'query': 'machine learning real-world applications healthcare finance AI'}, 'id': 'call_3dc5303fcdfb4a9fa0abb4e3', 'type': 'tool_call'}], invalid_tool_calls=[], usage_metadata={'input_tokens': 503, 'output_tokens': 50, 'total_tokens': 553, 'input_token_details': {}, 'output_token_details': {}}), ToolMessage(content='Search results for: machine learning real-world applications healthcare finance AI', name='web_search', id='84a5fe40-b905-446b-9a55-77c827c0807c', tool_call_id='call_3dc5303fcdfb4a9fa0abb4e3'), AIMessage(content='## Machine Learning: A Comprehensive Explanation**Machine Learning (ML)** is a subfield of artificial intelligence that focuses on developing algorithms and statistical models that enable computers to learn from data and make predictions or decisions without being explicitly programmed to do so.### Core ConceptAt its essence, machine learning is about creating systems that can automatically learn and improve from experience. Instead of following rigid, pre-programmed instructions, ML systems adapt their behavior based on patterns they discover in data.### Key Types of Machine Learning#### 1. **Supervised Learning**- **Definition**: The algorithm learns from labeled training data to make predictions or classifications.- **How it works**: You provide the system with input-output pairs (features and labels) during training.- **Common algorithms**:  - Linear Regression (for continuous outputs)\n  - Logistic Regression (for binary classification)  - Support Vector Machines  - Decision Trees and Random Forests  - Neural Networks- **Applications**: Spam detection, image recognition, credit scoring, medical diagnosis#### 2. **Unsupervised Learning**\n- **Definition**: The algorithm finds patterns in unlabeled data without predefined categories.- **How it works**: The system identifies inherent structures or groupings in the data.\n- **Common algorithms**:\n  - K-means Clustering  - Hierarchical Clustering  - Principal Component Analysis (PCA)\n  - Association Rules (Apriori)- **Applications**: Customer segmentation, anomaly detection, market basket analysis, dimensionality reduction#### 3. **Reinforcement Learning**\n- **Definition**: The algorithm learns by interacting with an environment and receiving rewards or penalties.- **How it works**: The system learns optimal actions through trial and error.- **Key concepts**: Agents, environments, states, actions, rewards- **Applications**: Game playing (AlphaGo), robotics, autonomous vehicles, resource management### Deep Learning (A Specialized Subset)Deep learning is a subset of machine learning that uses multi-layered neural networks (deep neural networks) to learn from data:\n\n- **Neural Networks**: Inspired by biological neurons, with layers of interconnected nodes- **Architectures**:  - Convolutional Neural Networks (CNNs) for image/video processing  - Recurrent Neural Networks (RNNs) for sequential data (text, time series)  - Transformers (like BERT, GPT) for natural language processing- **Key advantage**: Automatic feature extraction without manual engineering### The Machine Learning Process1. **Data Collection**: Gathering relevant data from various sources2. **Data Preprocessing**: Cleaning, normalization, handling missing values3. **Feature Engineering**: Selecting or creating relevant features4. **Model Selection**: Choosing appropriate algorithms5. **Training**: Feeding data to the algorithm to learn patterns6. **Evaluation**: Testing model performance on unseen data7. **Hyperparameter Tuning**: Optimizing model parameters8. **Deployment**: Implementing the model in production9. **Monitoring & Maintenance**: Continuously evaluating performance### Essential Algorithms and Techniques#### **Regression Algorithms**:- Linear Regression- Polynomial Regression- Ridge and Lasso Regression#### **Classification Algorithms**:\n- Logistic Regression- Naive Bayes- K-Nearest Neighbors (KNN)- Decision Trees- Support Vector Machines (SVM)#### **Ensemble Methods**:\n- Random Forest- Gradient Boosting (XGBoost, LightGBM, CatBoost)\n- Stacking and Bagging#### **Dimensionality Reduction**:- Principal Component Analysis (PCA)\n- t-SNE (t-distributed Stochastic Neighbor Embedding)\n- Autoencoders### Real-World Applications#### **Healthcare**:- Disease diagnosis and prediction- Drug discovery and development- Medical imaging analysis- Personalized treatment plans#### **Finance**:- Fraud detection- Algorithmic trading- Credit risk assessment- Portfolio management#### **Retail and E-commerce**:\n- Recommendation systems- Demand forecasting- Customer churn prediction- Price optimization#### **Technology**:- Natural Language Processing (chatbots, translation)- Computer Vision (facial recognition, object detection)\n- Speech recognition- Autonomous vehicles#### **Manufacturing**:- Predictive maintenance- Quality control- Supply chain optimization- Energy efficiency### Current Trends and Future Directions1. **AutoML**: Automated machine learning for easier implementation2. **Explainable AI (XAI)**: Making ML models more interpretable3. **Edge AI**: Running ML models on edge devices (phones, IoT)\n4. **Federated Learning**: Training models across decentralized devices5. **Generative AI**: Creating new content (images, text, code)\n6. **MLOps**: Machine Learning operations for scalable deployment7. **Quantum Machine Learning**: Combining ML with quantum computing### Challenges and Considerations#### **Technical Challenges**:\n- Data quality and quantity issues- Overfitting and underfitting- Computational requirements- Model interpretability#### **Ethical Considerations**:- Bias and fairness in algorithms- Privacy concerns- Transparency and accountability- Impact on employment#### **Practical Considerations**:\n- Infrastructure requirements- Maintenance costs- Integration with existing systems- Skill requirements### Getting Started with Machine Learning**Prerequisites**:\n- Mathematics: Linear algebra, calculus, statistics, probability- Programming: Python (most common), R, Julia- Libraries: scikit-learn, TensorFlow, PyTorch, pandas, numpy**Learning Path**:1. Basic Python programming2. Data manipulation with pandas3. Data visualization with matplotlib/seaborn4. Introduction to scikit-learn5. Deep learning with TensorFlow/PyTorch6. Advanced topics and specialization### Why Machine Learning MattersMachine learning is transforming virtually every industry by enabling:\n- More accurate predictions and decisions- Automation of complex tasks- Discovery of hidden patterns in data- Personalization at scale- Real-time processing and analysisThe field continues to evolve rapidly, with new architectures, algorithms, and applications emerging constantly. As data becomes increasingly abundant and computational power more accessible, machine learning is becoming an essential tool for solving complex problems across all domains of human endeavor.', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 1304, 'prompt_tokens': 582, 'total_tokens': 1886, 'completion_tokens_details': None, 'prompt_tokens_details': None}, 'model_provider': 'openai', 'model_name': 'deepseek-v3.2', 'system_fingerprint': None, 'id': 'chatcmpl-e73fc792-b712-93a4-8c07-db7246e61d1d', 'finish_reason': 'stop', 'logprobs': None}, id='lc_run--019b87c9-c3d3-78f3-95ba-a5a197eeeea5-0', tool_calls=[], invalid_tool_calls=[], usage_metadata={'input_tokens': 582, 'output_tokens': 1304, 'total_tokens': 1886, 'input_token_details': {}, 'output_token_details': {}})]}
'''